define(["config","core/backbone"],function(m,k){var z=function(r){function l(a){v.push(a)}function g(a,b){t[a]=t[a]||{};return $.extend(t[a],b)}function f(a){var b=a=a||{},c=b.name,e=function(){F(a);if("normal"===b.type)if(0<b.nav.length){var e=b.nav;$(".navigate").addClass("fixednav");require(["use/"+m.commonJsModule],function(b){for(var c=0,h=e.length;c<h;c++){var d=b[e[c]];d.addDataToModel($.extend({},d.options.model.defaults,a.navInfo));d.show()}})}else $(".navigate").addClass("fixednav")};if($.isEmptyObject(w[c]))if(w[c]=
{},u[c]={},t[c]=t[c]||{},b.url)B({url:b.url,success:function(a){a=g(c,a.data);a=new (d(b.model))(a);u[c].cid=a.cid;x.add(a);w[c]=new (p(c,b.view))({model:a});e()},error:function(a){console.error("ajax repsonse wrong:"+a)}});else{var h=g(c),h=new (d(b.model))(h);u[c].cid=h.cid;x.add(h);w[c]=new (p(c,b.view))({model:h});e()}else{if(!1===b.applyChange){e();return}if(b.url)B({url:b.url,success:function(a){g(c,a.data);x.get(u[c].cid).set(t[c]||{});e()},error:function(a){console.error("ajax response wrong:"+
a)}});else{var h=u[c].cid,f=t[c];!0===b.applyChange&&$.extend(f,{timeStr:+new Date});x.get(h).set(f||{});e()}}return w[c]}function d(a){a=$.extend({},a);return k.Model.extend(a)}function p(a,b){var c=$.extend({el:"#"+a,initialize:function(){this.render_bak();this.model.bind("change",this.render,this)},render:function(a){this.beforeRender&&this.beforeRender.call(this);a=this.$el;(a.find(".render").length?a.find(".render"):a).html(this.template(this.model.toJSON()));this.afterRender&&this.afterRender.call(this);
this.createScrollFresh();this.createSlider()},createScrollFresh:function(){var a=this.$el,b=this;if(a.find(".salut-need-scroll-fresh").length)a.find(".salut-need-scroll-fresh").on("scroll",function(a){var e=a.currentTarget;a=$(e);e=e.scrollHeight-e.clientHeight-1;a.scrollTop()>e&&b.scroll()})},createSlider:function(){this.$el.find(".salut-warper").length&&K(".salut-warper")},template:function(e){if(0!=$("#tpl"+a).length)return k.template($("#tpl"+a).html())(e)},render_bak:function(){var e=this;0!=
$("#tpl"+a).length?this.render():$.ajax({url:m.loadHtmlPath+G(a)+".html",async:!1,headers:{Accept:"text/html"},dataType:"html",success:function(b){$("body").append(b);e.render();k.Events.trigger(a+"-loadChildElement");k.Events.trigger("jumpback")}})}},b);return k.View.extend(c)}function q(a,b){BKData[a]=BKData[a]||{};if(b.url)return BKData[a].changed=BKData[a].url!=b.url,BKData[a].url=b.url,BKData[a].datas;BKData[a].datas=b;BKData[a].changed=!0;return BKData[a]}function H(a){var b=$.extend({},{el:"",
direction:"left",distance:100,callback:function(){},delay:m.pageTransformDelay},a),c=b.direction,e=b.distance,h=b.el,d="",f=$(window).width(),g=$(window).height();switch(c){case "left":h.css({display:"block",transform:"translate3d("+f+"px, 0, 0)","-webkit-transform":"translate3d("+f+"px, 0, 0)"});d="translate3d("+(100-e)*f/100+"px, 0, 0); width:"+e+"%;";break;case "right":h.css({display:"block",transform:"translate3d(-"+f+"px, 0, 0)"});d="translate3d(0, 0, 0); width:"+e+"%;";break;case "top":h.css({display:"block",
transform:"translate3d(0, "+g+"px, 0);"});d="translate3d(0, "+(100-e)*g/100+"px, 0); height:"+e+"%";break;case "bottom":h.css({display:"block",transform:"translate3d(0, -"+g+"px, 0);"}),d="translate3d(0, 0, 0); height:"+e+"%"}if(0==e)h.removeClass("page_show");else{h.addClass("page_show");setTimeout(function(){h[0].style.cssText="display: block; z-index:1000; -webkit-transform: "+d},17);var p=setTimeout(function(){"normal"===a.type&&(h[0].style.cssText="");b.callback.call(null);clearTimeout(p)},b.delay+
50)}}function B(a){if("undefined"===typeof a.url)return alert("\u8bf7\u8f93\u5165\u8bf7\u6c42\u5730\u5740\uff01");var b=a.success;a.success=function(e){0==e.status?a.wrong&&a.wrong(e)||alert(e.data):3==e.status?C.myNavigate("Login",!0):b&&b(e)};var c=a.complete;a.complete=function(e){c!==r&&c.call(null,e);void 0===a.modal&&y.toast({message:"loading...",status:"end"})};$.ajax($.extend({url:"",type:"GET",dataType:"json",beforeSend:function(){void 0===a.modal&&y.toast({message:"loading...",delay:m.ajaxDelay})},
error:function(a,b,c){y.tip({tipTxt:"\u7f51\u7edc\u8fde\u63a5\u5931\u8d25\uff0c\u9519\u8bef\u72b6\u6001\u7801:"+a.status})}},a||{}))}function F(a){var b=a.name,c=$("#"+b),e=a.type,h=a.direction||"";a=h.split("->")[0];h=(h.split("->")[1]||"100").replace(/\D/g,"");switch(e){case "normal":l(b);I=b;$("#pageWindow>.mask").hide().removeClass("move");a=a||L(b,z.getPreView());H({el:c,direction:a,distance:h,type:e,callback:function(){$("#pageWindow>.page_show").filter(function(){this.id!=b&&$(this).removeClass("page_show")})}});
break;case "mask":c.hasClass("showed")?(h=0,setTimeout(function(){c.removeClass("showed");c.hide()},m.maskTransformDelay)):(c.addClass("showed"),c.show());H({el:c.find(".mask-content"),direction:a,distance:h,type:e});break;case "navigate":$("#"+b).removeClass("fixednav")}}function G(a,b){var c=m.PAGERULES;a.indexOf("/")&&(a=a.split("/")[0].toLocaleLowerCase());for(var e in c)-1<c[e].indexOf(a)&&(a=e);return b?a:a.toLocaleLowerCase()}function L(a,b){var c="left";D(a).options.order<D(b).options.order&&
(c="right");return c}function J(a){return A.get(a)}function D(a){return A.get(a||I)}function K(a){function b(a,b){var c=e.length-1,d=a.index();return{left:function(){return d==c?e.first():a.next()},right:function(){return 0==d?e.last():a.prev()}}[b]()}function c(a,c){var d=b(a,c);e.removeClass("prev").removeClass("active");d.addClass("active");d=a;"right"===c&&(d=b(a,"right"),d=0===d.index()?e.last():d.prev());d.addClass("prev")}var e=$(a).children();e.first().addClass("active");e.last().addClass("prev");
e.on("swipeLeft",function(a){c($(a.currentTarget),"left")}).on("swipeRight",function(a){c($(a.currentTarget),"right")});return c}var u={},w={},t={},v=[],M=0,x=new k.Collection,I,E=$("#pageWindow"),N={_init:function(a){this.options=$.extend({name:"pageNull",applyChange:!0,type:"normal",model:{},view:{},nav:[],title:"",order:++M},a);this._createdom.call(this);this._createPage()},_createHtml:{navigate:function(a){var b=this.options.name;E.append("<"+b+' class="mui-bar mui-bar-nav fixednav '+a+'" id="'+
this.options.name+'"></'+b+">".trim())},mask:function(a){E.append('<div class="mask" id='+this.options.name+'><div class="mask-content render"></div></div>'.trim())},child:function(){var a=this.options,b=a.name,c=a.parent,e=this._bindParent();a.view.el="#"+c+" .child-"+b;k.Events.once(c+"-loadChildElement",function(){$("#"+c).find('div.child[name~="'+b+'"]').html('<div class="child-'+b+'"></div>'.trim());this.view=f(a);this._bindChildren(e)},this)},normal:function(a){for(var b=0;b<this.options.nav.length;b++)a+=
" hasnav-"+this.options.nav[b].toLocaleLowerCase();E.append('<div class="page '+a+'" id="'+this.options.name+'"><div class="content-box render"></div></div>'.trim())}},_createdom:function(){this._createHtml[this.options.type].call(this,this.options.type)},getOptions:function(){return this.options},_bindParent:function(){var a=J(this.options.parent);a.children=a.children||{};return a},_bindChildren:function(a){a.children[this.options.name]=this},_createPage:function(){this._MyEventToBackbone()},refreshView:function(){this._normal()},
_MyEventToBackbone:function(){var a=this.options.view.pageEvent;if(void 0!==this.options.view){var b=this.options.view.events={},c;for(c in a)if(a.hasOwnProperty(c)){var e=c.split("->"),d=e[0].replace(/^\s+|\s+$/gi,""),e=e[1].replace(/^\s+|\s+$/gi,"");b[d]=e;this.options.view[e]=a[c]}this.options.view.pageEvent=null}},reloadView:function(a){this.options.url?f(this.options,a):x.get(u[this.options.name].cid).set(a)},reloadAllChildren:function(a){var b=this.children,c;for(c in b)b[c].reloadView(a)},
addDataToModel:function(a){g(this.options.name,a)},show:function(){this._normal();return this},hide:function(){"mask"===this.options.type&&F(this.options)},_normal:function(a){var b=this.options;this.routeParams=a;var c=(b.models||function(){})()||{};b.url&&(url="function"===typeof b.url?b.url():b.url,b=(b=url.replace(/\[[^\]]*\]/g,function(e){e=e.replace(/\[|\]/g,"");-1<e.indexOf("|")?(e=e.split("|"),e=a[+e[0]]||e[1]):e=a[e]||"";return e}))||url,c={url:b});this.view=f($.extend({},this.options,c))},
loadPageModel:function(a){q(this.n,a||{})},loadPageView:function(a){a=$.extend({},{name:this.n},a);_createProject(a)},_Route:function(){this.title&&y.setPageTitle(this.title);this._normal([].slice.call(arguments,0))}},A=function(){var a=[];return{add:function(b,c){a.push({name:b,page:c});return c},get:function(b){for(var c=0,e=a.length;c<e;c++)if(a[c].name==b)return a[c].page;return 0},list:function(){return a}}}();return{Data:{create:q,get:function(a){return BKData[a]||{}}},getAllBooks:function(){for(var a=
[],b=0;0>b;b++)a.push(b.toString());return a},Observer:A,getViewOrder:function(a){return a===r?v:v[a]},getPreView:function(){return v[v.length-2]},pushThisView:l,ajax:B,getActiveRoute:D,getModule:J,createPage:function(a){a=a||{};var b=function(){var b=k.truss(this._Route,this);this._init.call(this,a);a.route&&C.route(a.route,this.n,b)};$.extend(b.prototype,N,a.fn||{});b=new b;return A.add(a.name,b)},getParams:function(a){for(var b=location.search.replace(/^\?/,"").split("&"),c,e=0,d=b.length;e<d;e++){var f=
b[e].split("=");a===f[0]&&(c=f[1])}return c},verifly:function(a){function b(a,b){var d=b.veriflyType.split(":");return c[d[0]].apply(null,[a,d[1]])}var c=$.extend({text:function(a,b){if(""===a)return!1},maxLength:function(a,b){if(a.length>b)return!1},minLength:function(a,b){if(a.length<b)return!1},phone:function(a){if(!/^1[3|8|5][0-9]{9}$/.test(a))return!1},tall:function(a){if(a&&!/^1\d{2}$/.test(a))return!1},weight:function(a){if(a&&!/^\d{2}$/.test(a))return!1},img:function(a){if(a&&1E3<a.size/1024&&
!/\.jpg|\.png/.test(a.name))return!1}},a);return function(a){for(var c,d=0;d<a.length;d++){c=a[d].value;var f=a[d].rules,g=void 0;if($.isPlainObject(f))c=b.apply(null,[c,f]),!1===c&&(g=f.errorMessgag);else for(var p=0;p<f.length;p++)if(!1===b.apply(null,[c,f[p]])){g=f[p].errorMessgag;break}c=g;if(void 0!==c)break}return c}},filterHash:G}}(),C=new (k.Router.extend({myNavigate:function(r,l){l=l||function(){};var g=r.replace(/\(.*\)/gi,"").replace(/#/,"").split("/")[0],f=z.Observer.get(g);if(f)l.call(f),
this.navigate(r,!0);else{var d=this;require([m.loadJsPath+z.filterHash(g,1)],function(f){d.navigate("#"+r,!0);if(l)if(f[g].children)k.Events.once("jumpback",function(){l.call(this)},f[g]);else l.call(f[g])})}}})),y=function(k,l){var g={publicVar:{},get:function(f){return this.publicVar[f]||l},set:function(f,d){this.publicVar[f]=d},setPageTitle:function(f){document.title=f;if("iphone"==navigator.userAgent.toLowerCase().match(/iphone/i)){f=$("body");var d=$('<iframe style="display:none;" src="/favicon.ico"></iframe>').on("load",
function(){setTimeout(function(){d.off("load").remove()},0)}).appendTo(f)}},message:function(f){var d=$.extend({type:"alert",title:"\u4f60\u786e\u8ba4\u8981\u8fd9\u6837\u505a\u5417\uff1f",height:$(window).height()},f),g=$(".J-message");f=$(".J-message .J-"+d.type);var q=g.find(".J-"+d.type+" .J-ok"),k=g.find(".J-"+d.type+" .J-cancel");g.height(d.height);$(".J-message .J-box").addClass("g-d-n").removeClass("g-d-b");f.addClass("g-d-b").removeClass("g-d-n");f.find(".J-word").text(d.title);g.addClass("g-d-b").removeClass("g-d-n");
q.off();q.on("tap",function(){"function"==typeof d.ok&&d.ok();g.addClass("g-d-n").removeClass("g-d-b")});0!=k.length&&(k.off(),k.on("tap",function(){"function"==typeof d.cancel&&d.cancel();g.addClass("g-d-n").removeClass("g-d-b")}))},tip:function(f){if("1"!=$(".J-tip").attr("showed")){$(".J-tip").attr("showed","1");var d={tipTxt:"this is tip text!!",delay:2E3,callBack:function(){},callBackPram:""};$.extend(d,f||{});$(".J-tip").find(".J-tipWp").html(d.tipTxt);setTimeout(function(){var d=0-$(".J-tip").height()/
2;$(".J-tip").find(".J-tipWp").css({top:d});$(".J-tip").addClass("_tipBx-show")},100);setTimeout(function(){$(".J-tip").removeClass("_tipBx-show");$(".J-tip").attr("showed","0");d.callBack&&"function"==typeof d.callBack&&d.callBack(d.callBackPram)},d.delay)}},toast:function(f){"end"===f.status&&(clearTimeout(g.publicVar["toast-meter"]),$(".J-loadingoutsidebox").addClass("g-d-n"),g.publicVar["toast-key"]=void 0);var d=$.extend({message:"loading",delay:100,type:"loading",callback:function(){}},f);if(void 0===
g.publicVar["toast-key"]){g.publicVar["toast-key"]=1;f=$(window).height();var k=$(window).width()/2-40;f='<div class="J-loadingoutsidebox"><div class="am-toast-text-background"></div><div class="am-toast-text J-toast" style="top:'+(f/2-60)+"px; left:"+k+'px;"><span class="am-icon" am-mode="'+d.type+'"></span><em>'+d.message+"</em></div></div>";if($(".J-loadingoutsidebox").length){var q=$(".J-loadingoutsidebox").removeClass("g-d-n");q.find(".am-icon").attr("am-mode",d.type).next().html(d.message)}else q=
$("body").append(f).find(".J-loadingoutsidebox");g.publicVar["toast-meter"]=setTimeout(function(){clearTimeout(g.publicVar["toast-meter"]);g.publicVar["toast-meter"]=null;g.publicVar["toast-key"]=void 0;q.addClass("g-d-n");d.callback()},d.delay)}},loadCss:function(f){switch(f){case 1:case 3:case 4:return"class='status_cfmt'";default:return"class='status_ct'"}},now:function(){function f(d){10>d&&(d="0"+d);return d}var d=new Date,g=d.getFullYear(),k=d.getMonth()+1,k=f(k),l=f(d.getDate()),m=f(d.getHours()),
r=f(d.getMinutes()),d=f(d.getSeconds());return g+"-"+k+"-"+l+" "+m+":"+r+":"+d}};return k.PB=g}(window);return{PDW:z,Router:C}});